<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brilliant Consulting - Home</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
</head>
<body>
  <header>
    <div class="logo">Brilliant <span>Consulting</span></div>
    <nav>
      <% if (userName) { %>
        <a href="/home">Home</a>
        <a href="/services">Services</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/auth/logout" class="logout-btn">Logout</a>
      <% } else { %>
        <a href="/services">Services</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/">Login</a>
        <a href="/signup">Sign Up</a>
      <% } %>
    </nav>
  </header>
  <div class="calendly-ui-container">
    <!-- Sidebar: Account & Appointment Info -->
    <aside class="calendly-ui-sidebar">
      <div class="calendly-ui-account">
        <div class="calendly-ui-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="calendly-ui-account-details">
          <div class="calendly-ui-account-name"><%= userName %></div>
          <div class="calendly-ui-account-label">My account</div>
        </div>
      </div>
      <div class="calendly-ui-service">
        <div class="calendly-ui-service-title">Consultation with an Expert</div>
        <div class="calendly-ui-service-duration">
          <i class="fas fa-clock"></i> 60 min
        </div>
        <div class="calendly-ui-service-price">
          <i class="fas fa-dollar-sign"></i> $50.00
        </div>
        <div class="calendly-ui-service-note">
          You will see the contact information of the consultant after payment.
        </div>
      </div>
    </aside>
    <!-- Main: Calendar & Time Selection -->
    <main class="calendly-ui-main">
      <div class="calendly-ui-header">
        <h2>Data &amp; Time selection</h2>
      </div>
      <!-- Replace your .calendly-ui-calendar-area div with this markup for a true SaaS horizontal layout -->
      <div class="calendly-ui-calendar-area calendly-ui-flex">
        <div id="calendly-calendar" class="calendly-ui-calendar"></div>
        <div class="calendly-ui-timeslot-panel" id="calendly-timeslot-panel">
          <div class="calendly-ui-timeslot-placeholder">
            Please select a date from the calendar to view available time slots.
          </div>
          <div class="calendly-ui-timeslot-content">
            <div class="calendly-ui-timeslot-header">
              <span id="selectedDateLabel"></span>
            </div>
            <form id="bookingForm" class="calendly-ui-timeslot-form">
              <input type="hidden" id="bookingDate" name="date" />
              <input type="hidden" id="timeSlot" name="timeSlot" />
              <div class="calendly-ui-timeslot-list" id="timeslotList"></div>
              <div class="mb-3">
                <label for="consultationType" class="form-label">
                  <i class="fas fa-briefcase"></i> Consultation Type
                </label>
                <select id="consultationType" class="form-select">
                  <option value="">-- Select Consultation Type --</option>
                  <option value="IT Strategy">IT Strategy Consultation</option>
                  <option value="Digital Transformation">Digital Transformation</option>
                  <option value="Software Development">Software Development Planning</option>
                  <option value="Data Analytics">Data Analytics Review</option>
                  <option value="General">General Business Consultation</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="notes" class="form-label">
                  <i class="fas fa-sticky-note"></i> Additional Notes <span class="text-muted">(Optional)</span>
                </label>
                <textarea 
                  id="notes" 
                  class="form-control" 
                  rows="3" 
                  placeholder="Please provide any specific topics you'd like to discuss or special requirements...">
                </textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" onclick="hideTimeSlotPanel()">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  Confirm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="calendly-ui-timezone">
        <i class="fas fa-globe"></i> Local Time (<span id="localTime"></span>)
      </div>
      <div id="appointmentModal" class="modal fade" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content subtle-modal">
            <div class="modal-header">
              <h5 class="modal-title" id="appointmentModalLabel">
                <i class="fas fa-calendar-check"></i> Appointment Details
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="appointmentDetails"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="button" class="btn btn-danger" id="cancelAppointmentBtn">
                Cancel Appointment
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="cancelModal" class="modal fade" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content subtle-modal">
            <div class="modal-header">
              <h5 class="modal-title" id="cancelModalLabel">
                <i class="fas fa-ban"></i> Cancel Appointment
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning mb-3" style="background: #f7f8fa; color: #334155; border-left: 4px solid #eeb8c2;">
                <strong>Are you sure you want to cancel this appointment?</strong>
                <div id="cancelAppointmentDetails"></div>
              </div>
              <div class="mb-3">
                <label for="cancellationReason" class="form-label">
                  Reason for Cancellation <span class="text-muted">(Optional)</span>
                </label>
                <select id="cancellationReason" class="form-select">
                  <option value="">-- Select Reason --</option>
                  <option value="Schedule Conflict">Schedule Conflict</option>
                  <option value="Personal Emergency">Personal Emergency</option>
                  <option value="Need to Reschedule">Need to Reschedule</option>
                  <option value="No Longer Needed">No Longer Needed</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="cancellationNotes" class="form-label">
                  Additional Notes <span class="text-muted">(Optional)</span>
                </label>
                <textarea id="cancellationNotes" class="form-control" rows="2"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Keep Appointment
              </button>
              <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                Yes, Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <%- include('partials/footer') %>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('localTime').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
      var calendarEl = document.getElementById('calendly-calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        timeZone: 'local',
        initialView: 'dayGridMonth',
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        events: {
          url: '/appointments',
          method: 'GET',
          failure: function() {
            alert('Failed to load existing appointments');
          }
        },
        select: function (info) {
          showTimeSlotPanel(info.startStr);
        },
        eventClick: function(info) {
          // Show appointment modal with details
          const event = info.event;
          const detailsHtml = `
            <div class="mb-2"><strong>Date:</strong> ${event.start.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
            <div class="mb-2"><strong>Time:</strong> ${event.title}</div>
            <div class="mb-2"><strong>Type:</strong> ${event.extendedProps.consultationType || 'General'}</div>
            <div class="mb-2"><strong>Notes:</strong> ${event.extendedProps.notes || 'None'}</div>
          `;
          document.getElementById('appointmentDetails').innerHTML = detailsHtml;
          document.getElementById('cancelAppointmentBtn').onclick = function() {
            showCancelModal(event);
          };
          new bootstrap.Modal(document.getElementById('appointmentModal')).show();
        },
        eventContent: function(arg) {
          // Subtle appointment display
          return { html: `<div class="fc-event-content"><span>${arg.event.title}</span></div>` };
        }
      });
      calendar.render();

      window.showTimeSlotPanel = function(dateStr) {
        // Parse as local date, not UTC
        const parts = dateStr.split('-');
        const localDate = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        document.getElementById('selectedDateLabel').textContent = localDate.toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
        document.getElementById('bookingDate').value = dateStr;
        document.getElementById('calendly-timeslot-panel').classList.add('active');
        renderTimeSlots();
      }
      window.hideTimeSlotPanel = function() {
        document.getElementById('calendly-timeslot-panel').classList.remove('active');
        document.getElementById('bookingDate').value = '';
        document.getElementById('timeSlot').value = '';
      }
      window.renderTimeSlots = function() {
        const slots = [
          "09:00 AM", "10:00 AM", "11:00 AM", "01:00 PM", "02:00 PM", "03:00 PM", "04:00 PM"
        ];
        const list = document.getElementById('timeslotList');
        list.innerHTML = '';
        slots.forEach(slot => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'calendly-ui-timeslot-btn';
          btn.textContent = slot;
          btn.onclick = () => {
            document.querySelectorAll('.calendly-ui-timeslot-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('timeSlot').value = slot;
          };
          list.appendChild(btn);
        });
      }

      // Cancel modal logic
      let currentCancelEvent = null;
      window.showCancelModal = function(event) {
        currentCancelEvent = event;
        document.getElementById('appointmentModal').querySelector('.btn-close').click();
        document.getElementById('cancelAppointmentDetails').innerHTML = `
          <div><strong>Date:</strong> ${event.start.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
          <div><strong>Time:</strong> ${event.title}</div>
          <div><strong>Type:</strong> ${event.extendedProps.consultationType || 'General'}</div>
        `;
        new bootstrap.Modal(document.getElementById('cancelModal')).show();
      };
      document.getElementById('confirmCancelBtn').onclick = async function() {
        if (!currentCancelEvent) return;
        const reason = document.getElementById('cancellationReason').value;
        const notes = document.getElementById('cancellationNotes').value;
        try {
          const response = await fetch(`/appointments/${currentCancelEvent.id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, notes })
          });
          if (response.ok) {
            currentCancelEvent.remove();
            bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
            document.getElementById('cancellationReason').value = '';
            document.getElementById('cancellationNotes').value = '';
            calendar.refetchEvents();
            alert('Appointment cancelled.');
          } else {
            alert('Error cancelling appointment.');
          }
        } catch (error) {
          alert('Failed to cancel appointment.');
        }
        currentCancelEvent = null;
      };

      document.getElementById('bookingForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const dateStr = document.getElementById('bookingDate').value;
        const timeSlot = document.getElementById('timeSlot').value;
        const notes = document.getElementById('notes').value;
        const consultationType = document.getElementById('consultationType')?.value || 'General';

        if (!dateStr || !timeSlot) {
          alert('Please select a date and time slot');
          return;
        }

        function to24Hour(time12h) {
          const [time, modifier] = time12h.split(' ');
          let [hours, minutes] = time.split(':');
          if (modifier === 'PM' && hours !== '12') hours = String(Number(hours) + 12);
          if (modifier === 'AM' && hours === '12') hours = '00';
          return `${hours.padStart(2, '0')}:${minutes}`;
        }
        const time24 = to24Hour(timeSlot);
        const localDateTime = new Date(`${dateStr}T${time24}:00`);
        const isoDateTime = localDateTime.toISOString();

        const bookRes = await fetch('/appointments/book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: isoDateTime, timeSlot, notes, consultationType })
        });

        if (!bookRes.ok) {
          alert('❌ Error: Could not save booking info.');
          return;
        }

        const payRes = await fetch('/payments/create-checkout-session', { method: 'POST' });
        const data = await payRes.json();
        if (data.url) {
          window.location = data.url;
        } else {
          alert('❌ Error: Invalid response from server');
        }
      });
    });
  </script>

</body>
</html>


